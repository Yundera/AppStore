name: nextcloud

services:
  nextcloud:
    image: nextcloud:31.0.7
    container_name: nextcloud
    user: $PUID:$PGID
    depends_on:
      - db
      - redis
      - collabora
    deploy:
      resources:
        limits:
          memory: 2048M
          cpus: '2.0'
    expose:
      - 80
    environment:
      - PUID=$PUID                                    # Process user ID / í”„ë¡œì„¸ìŠ¤ ì‚¬ìš©ì ID
      - PGID=$PGID                                    # Process group ID / í”„ë¡œì„¸ìŠ¤ ê·¸ë£¹ ID
      - TZ=$TZ                                        # Timezone setting / ì‹œê°„ëŒ€ ì„¤ì •
      - MYSQL_HOST=db                                 # MySQL/MariaDB host name / MySQL/MariaDB í˜¸ìŠ¤íŠ¸ëª…
      - MYSQL_DATABASE=nextcloud                      # Database name for Nextcloud / Nextcloudìš© ë°ì´í„°ë² ì´ìŠ¤ëª…
      - MYSQL_USER=nextcloud                          # Database username / ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©ìëª…
      - MYSQL_PASSWORD=$default_pwd                   # Database password / ë°ì´í„°ë² ì´ìŠ¤ ë¹„ë°€ë²ˆí˜¸
      - NEXTCLOUD_TRUSTED_DOMAINS=localhost $domain nextcloud  # Trusted domains for access / ì ‘ê·¼ í—ˆìš© ë„ë©”ì¸ë“¤
      - OVERWRITEPROTOCOL=https                       # Force HTTPS protocol / HTTPS í”„ë¡œí† ì½œ ê°•ì œ ì‚¬ìš©
      - OVERWRITEHOST=$domain                         # Override host for URL generation / URL ìƒì„±ìš© í˜¸ìŠ¤íŠ¸ ì˜¤ë²„ë¼ì´ë“œ
      - REDIS_HOST=redis                              # Redis cache server hostname / Redis ìºì‹œ ì„œë²„ í˜¸ìŠ¤íŠ¸ëª…
      - REDIS_HOST_PORT=6379                          # Redis server port / Redis ì„œë²„ í¬íŠ¸
      - REDIS_HOST_PASSWORD=$default_pwd              # Redis authentication password / Redis ì¸ì¦ ë¹„ë°€ë²ˆí˜¸
      - NEXTCLOUD_INIT_HTACCESS=true                  # Initialize .htaccess file / .htaccess íŒŒì¼ ì´ˆê¸°í™”
      - PHP_MEMORY_LIMIT=2048M                        # PHP memory limit / PHP ë©”ëª¨ë¦¬ ì œí•œ
      - PHP_UPLOAD_LIMIT=1024M                        # PHP file upload size limit / PHP íŒŒì¼ ì—…ë¡œë“œ í¬ê¸° ì œí•œ
    volumes:
      - /DATA/AppData/$AppID/html:/var/www/html
      - /DATA/AppData/$AppID/config:/var/www/html/config
      - /DATA/AppData/$AppID/data:/var/www/html/data
    restart: unless-stopped
    networks:
      - nextcloud-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/status.php"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  db:
    image: mariadb:11.2
    container_name: nextcloud_db
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    environment:
      - TZ=$TZ                                        # Timezone setting / ì‹œê°„ëŒ€ ì„¤ì •
      - MYSQL_ROOT_PASSWORD=$default_pwd              # MySQL root user password / MySQL root ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸
      - MYSQL_DATABASE=nextcloud                      # Database name to create / ìƒì„±í•  ë°ì´í„°ë² ì´ìŠ¤ëª…
      - MYSQL_USER=nextcloud                          # Database user to create / ìƒì„±í•  ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©ì
      - MYSQL_PASSWORD=$default_pwd                   # Password for database user / ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸
      - MARIADB_AUTO_UPGRADE=1                        # Enable automatic database upgrades / ìë™ ë°ì´í„°ë² ì´ìŠ¤ ì—…ê·¸ë ˆì´ë“œ í™œì„±í™”
      - MARIADB_DISABLE_UPGRADE_BACKUP=1              # Disable backup during upgrades / ì—…ê·¸ë ˆì´ë“œ ì‹œ ë°±ì—… ë¹„í™œì„±í™”
    volumes:
      - /DATA/AppData/$AppID/db:/var/lib/mysql
    restart: unless-stopped
    networks:
      - nextcloud-network
    # MariaDB performance optimization for Nextcloud / Nextcloudë¥¼ ìœ„í•œ MariaDB ì„±ëŠ¥ ìµœì í™”
    command: >
      --innodb-buffer-pool-size=256M
      --transaction-isolation=READ-COMMITTED
      --binlog-format=ROW
      --innodb-file-per-table=1
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$default_pwd"]
      interval: 30s
      timeout: 10s
      retries: 3

  redis:
    image: redis:7.2-alpine
    container_name: nextcloud_redis
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.2'
    # Redis with password authentication and data persistence / ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ê³¼ ë°ì´í„° ì§€ì†ì„±ì„ ê°€ì§„ Redis
    command: redis-server --requirepass $default_pwd --appendonly yes
    volumes:
      - /DATA/AppData/$AppID/redis:/data
    restart: unless-stopped
    networks:
      - nextcloud-network
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "$default_pwd", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  nextcloud-network:
    driver: bridge

x-casaos:
  main: nextcloud
  webui_port: 80
  category: Utilities
  architectures: [amd64, arm64]
  author: Yundera Team
  developer: Nextcloud GmbH
  pre-install-cmd: |
    rm -rf /DATA/AppData/$AppID/* &&
    mkdir -p /DATA/AppData/$AppID/{config,data,html,db,redis,collabora/tmp} &&
    chown -R $PUID:$PGID /DATA/AppData/$AppID &&
    chmod -R 755 /DATA/AppData/$AppID
  title:
    en_us: Nextcloud
    ko_kr: Nextcloud
  tagline:
    en_us: Personal cloud with Collabora document editing
    ko_kr: Collabora ë¬¸ì„œ í¸ì§‘ì´ í¬í•¨ëœ ê°œì¸ í´ë¼ìš°ë“œ
  icon: https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Nextcloud/icon.png
  screenshot_link:
    - https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Nextcloud/screenshot-1.png
    - https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Nextcloud/screenshot-2.png
    - https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Nextcloud/screenshot-3.png
  thumbnail: https://cdn.jsdelivr.net/gh/Yundera/AppStore@main/Apps/Nextcloud/thumbnail.png
  description:
    en_us: |
      **â˜ï¸ Nextcloud with Collabora Integration**

      Complete personal cloud solution with **Collabora Online** document server for professional document editing.

      **ğŸš€ What's Included:**
      â€¢ **Nextcloud** - File management, sharing, calendar, contacts
      â€¢ **Collabora Online** - Professional document editing server
      â€¢ **Redis Cache** - Optimized performance
      â€¢ **MariaDB** - Reliable database backend

      **ğŸ“ Office Features:**
      â€¢ **Word Documents** (.docx, .doc) - Full editing capabilities
      â€¢ **Excel Spreadsheets** (.xlsx, .xls) - Advanced formulas and charts
      â€¢ **PowerPoint Presentations** (.pptx, .ppt) - Rich media support
      â€¢ **Real-time Collaboration** - Multiple users editing simultaneously
      â€¢ **Comment System** - Review and feedback workflow
      â€¢ **Version History** - Track document changes

      **ğŸ”§ Technical Features:**
      â€¢ **NSL Router Compatible** - Clean HTTPS URLs
      â€¢ **Privileged Container** - Proper jail permissions for Collabora
      â€¢ **High Performance** - Dedicated resources for document editing
      â€¢ **Secure** - All data stays on your server

      **Perfect for teams and individuals who need professional document editing with complete privacy control!**
    ko_kr: |
      **â˜ï¸ Collabora í†µí•© Nextcloud**

      ì „ë¬¸ì ì¸ ë¬¸ì„œ í¸ì§‘ì„ ìœ„í•œ **Collabora Online** ë¬¸ì„œ ì„œë²„ê°€ í¬í•¨ëœ ì™„ì „í•œ ê°œì¸ í´ë¼ìš°ë“œ ì†”ë£¨ì…˜ì…ë‹ˆë‹¤.

      **ğŸš€ í¬í•¨ëœ ê¸°ëŠ¥:**
      â€¢ **Nextcloud** - íŒŒì¼ ê´€ë¦¬, ê³µìœ , ì¼ì •, ì—°ë½ì²˜
      â€¢ **Collabora Online** - ì „ë¬¸ì ì¸ ë¬¸ì„œ í¸ì§‘ ì„œë²„
      â€¢ **Redis ìºì‹œ** - ìµœì í™”ëœ ì„±ëŠ¥
      â€¢ **MariaDB** - ì•ˆì •ì ì¸ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—”ë“œ

      **ğŸ“ ì˜¤í”¼ìŠ¤ ê¸°ëŠ¥:**
      â€¢ **Word ë¬¸ì„œ** (.docx, .doc) - ì™„ì „í•œ í¸ì§‘ ê¸°ëŠ¥
      â€¢ **Excel ìŠ¤í”„ë ˆë“œì‹œíŠ¸** (.xlsx, .xls) - ê³ ê¸‰ ìˆ˜ì‹ ë° ì°¨íŠ¸
      â€¢ **PowerPoint í”„ë ˆì  í…Œì´ì…˜** (.pptx, .ppt) - í’ë¶€í•œ ë¯¸ë””ì–´ ì§€ì›
      â€¢ **ì‹¤ì‹œê°„ í˜‘ì—…** - ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ë™ì‹œì— í¸ì§‘
      â€¢ **ëŒ“ê¸€ ì‹œìŠ¤í…œ** - ê²€í†  ë° í”¼ë“œë°± ì›Œí¬í”Œë¡œ
      â€¢ **ë²„ì „ ê¸°ë¡** - ë¬¸ì„œ ë³€ê²½ ì‚¬í•­ ì¶”ì 

      **ğŸ”§ ê¸°ìˆ ì  ê¸°ëŠ¥:**
      â€¢ **NSL Router í˜¸í™˜** - ê¹”ë”í•œ HTTPS URL
      â€¢ **íŠ¹ê¶Œ ì»¨í…Œì´ë„ˆ** - Collaboraë¥¼ ìœ„í•œ ì ì ˆí•œ jail ê¶Œí•œ
      â€¢ **ê³ ì„±ëŠ¥** - ë¬¸ì„œ í¸ì§‘ì„ ìœ„í•œ ì „ìš© ë¦¬ì†ŒìŠ¤
      â€¢ **ë³´ì•ˆ** - ëª¨ë“  ë°ì´í„°ê°€ ì„œë²„ì— ë³´ê´€

      **ì™„ì „í•œ ê°œì¸ì •ë³´ ë³´í˜¸ í†µì œì™€ í•¨ê»˜ ì „ë¬¸ì ì¸ ë¬¸ì„œ í¸ì§‘ì´ í•„ìš”í•œ íŒ€ê³¼ ê°œì¸ì—ê²Œ ì™„ë²½í•©ë‹ˆë‹¤!**
  tips:
    before_install:
      en_us: |
        **ğŸš€ Nextcloud + Collabora Setup Guide**
        
        **What This Includes:**
        âœ… Nextcloud with all features
        âœ… Collabora Online server (dedicated)
        âœ… Redis cache for performance
        âœ… MariaDB database
        âœ… NSL Router optimized configuration
        
        **ğŸ“‹ After Installation:**
        1. **Wait 4-5 minutes** for Collabora to fully initialize
        2. **Access Nextcloud:** `https://nextcloud-username.nsl.sh`
        3. **Complete setup wizard** (create admin account)
        4. **Install Nextcloud Office app:**
           - Go to **Apps** â†’ Search "**Nextcloud Office**"
           - Click **Download and enable**
        5. **Configure Collabora:**
           - Go to **Settings** â†’ **Office**
           - Select "**Use your own server**"
           - **Server URL:** `https://9980-nextcloud-username.nsl.sh/`
           - **Secret key:** Leave blank
           - **Check:** "Disable certificate verification" âœ…
           - **Advanced settings:** Add WOPI allow-list: `172.17.0.0/16`
           - Click **Save**
        
        **ğŸ¯ Test Collabora:**
        - Go to **Files** â†’ **+ button**
        - You should see: **Document**, **Spreadsheet**, **Presentation**
        - Click any option â†’ Collabora editor opens!
        
        **ğŸ’¡ Troubleshooting:**
        - First document load takes 1-2 minutes (normal)
        - If connection fails, wait longer - Collabora needs time
        - Collabora runs on external port 9980 for NSL Router access
        
        **Fixed the TRUSTED_PROXIES error that caused 502 Bad Gateway!**
      ko_kr: |
        **ğŸš€ Nextcloud + Collabora ì„¤ì • ê°€ì´ë“œ**
        
        **í¬í•¨ëœ ê¸°ëŠ¥:**
        âœ… ëª¨ë“  ê¸°ëŠ¥ì´ í¬í•¨ëœ Nextcloud
        âœ… Collabora Online ì„œë²„ (ì „ìš©)
        âœ… ì„±ëŠ¥ì„ ìœ„í•œ Redis ìºì‹œ
        âœ… MariaDB ë°ì´í„°ë² ì´ìŠ¤
        âœ… NSL Router ìµœì í™” êµ¬ì„±
        
        **ğŸ“‹ ì„¤ì¹˜ í›„:**
        1. **4-5ë¶„ ëŒ€ê¸°** - Collabora ì™„ì „ ì´ˆê¸°í™”ë¥¼ ìœ„í•´
        2. **Nextcloud ì ‘ì†:** `https://nextcloud-ì‚¬ìš©ìëª….nsl.sh`
        3. **ì„¤ì • ë§ˆë²•ì‚¬ ì™„ë£Œ** (ê´€ë¦¬ì ê³„ì • ìƒì„±)
        4. **Nextcloud Office ì•± ì„¤ì¹˜:**
           - **ì•±** â†’ "**Nextcloud Office**" ê²€ìƒ‰
           - **ë‹¤ìš´ë¡œë“œ ë° í™œì„±í™”** í´ë¦­
        5. **Collabora êµ¬ì„±:**
           - **ì„¤ì •** â†’ **Office**ë¡œ ì´ë™
           - "**Use your own server**" ì„ íƒ
           - **ì„œë²„ URL:** `https://9980-nextcloud-ì‚¬ìš©ìëª….nsl.sh/`
           - **Secret key:** ë¹„ì›Œë‘ê¸°
           - **ì²´í¬:** "Disable certificate verification" âœ…
           - **ê³ ê¸‰ ì„¤ì •:** WOPI í—ˆìš© ëª©ë¡ì— `172.17.0.0/16` ì¶”ê°€
           - **ì €ì¥** í´ë¦­
        
        **ğŸ¯ Collabora í…ŒìŠ¤íŠ¸:**
        - **íŒŒì¼** â†’ **+ ë²„íŠ¼**ìœ¼ë¡œ ì´ë™
        - ë‹¤ìŒì´ ë³´ì—¬ì•¼ í•¨: **ë¬¸ì„œ**, **ìŠ¤í”„ë ˆë“œì‹œíŠ¸**, **í”„ë ˆì  í…Œì´ì…˜**
        - ì•„ë¬´ ì˜µì…˜ í´ë¦­ â†’ Collabora í¸ì§‘ê¸° ì—´ë¦¼!
        
        **ğŸ’¡ ë¬¸ì œ í•´ê²°:**
        - ì²« ë¬¸ì„œ ë¡œë“œëŠ” 1-2ë¶„ ì†Œìš” (ì •ìƒ)
        - ì—°ê²° ì‹¤íŒ¨ ì‹œ ë” ê¸°ë‹¤ë¦¬ê¸° - Collabora ì´ˆê¸°í™” ì‹œê°„ í•„ìš”
        - CollaboraëŠ” NSL Router ì ‘ê·¼ì„ ìœ„í•´ ì™¸ë¶€ í¬íŠ¸ 9980ì—ì„œ ì‹¤í–‰
        
        **502 Bad Gatewayë¥¼ ì¼ìœ¼í‚¤ë˜ TRUSTED_PROXIES ì˜¤ë¥˜ë¥¼ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤!**
  index: /